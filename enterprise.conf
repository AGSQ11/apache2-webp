# enterprise.conf - Enterprise-grade Apache configuration for mod_webp
# Production-ready configuration with strict mode and enhanced security

# Load the module
LoadModule webp_module modules/mod_webp.so

# Global WebP settings for enterprise deployment
<IfModule mod_webp.c>
    # Default enterprise settings
    WebPEnabled On
    WebPStrictMode On  # STRICT: No images escape conversion
    WebPQuality 90.0   # High quality for enterprise
    WebPCacheDir /var/cache/mod_webp_enterprise
    WebPMaxFileSize 104857600  # 100MB max file size
    WebPMaxWidth 32768   # Support large images
    WebPMaxHeight 32768
    WebPCacheTimeout 7200  # 2 hour cache timeout
    WebPLogLevel 1      # WARN level for production
    WebPAllowedFormats "jpeg,png,bmp,tiff,gif"  # No WebP passthrough in strict mode
</IfModule>

# Production Virtual Host with strict WebP enforcement
<VirtualHost *:443>
    ServerName images.enterprise.local
    DocumentRoot /var/www/enterprise/images

    # SSL Configuration (recommended for enterprise)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/enterprise.crt
    SSLCertificateKeyFile /etc/ssl/private/enterprise.key

    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"

    # Main images directory with strict WebP conversion
    <Directory "/var/www/enterprise/images">
        Options -Indexes -MultiViews
        AllowOverride None
        Require all granted

        # Enterprise WebP settings - STRICT MODE
        WebPEnabled On
        WebPStrictMode On  # NO IMAGE ESCAPES - ALL MUST BE CONVERTED
        WebPQuality 92.0
        WebPCacheDir /var/cache/mod_webp_enterprise/main
        WebPMaxFileSize 52428800  # 50MB
        WebPLogLevel 1  # Production logging
        WebPAllowedFormats "jpeg,png,bmp,tiff,gif"

        # Apply to ALL image files - no exceptions
        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler
            # Additional security headers for images
            Header set Cache-Control "public, max-age=31536000, immutable"
            Header set Vary "Accept"
        </FilesMatch>

        # Block direct access to non-WebP images in strict mode
        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            # In strict mode, browsers that don't support WebP get 406 Not Acceptable
            SetEnvIf Accept "image/webp" webp_supported
            Order allow,deny
            Allow from env=webp_supported
            Deny from all
        </FilesMatch>
    </Directory>

    # Thumbnails directory with different settings
    <Directory "/var/www/enterprise/images/thumbs">
        Options -Indexes -MultiViews
        AllowOverride None
        Require all granted

        # Thumbnails - smaller files, higher compression
        WebPEnabled On
        WebPStrictMode On
        WebPQuality 80.0  # Lower quality for thumbnails
        WebPCacheDir /var/cache/mod_webp_enterprise/thumbs
        WebPMaxFileSize 10485760  # 10MB for thumbnails
        WebPMaxWidth 2048
        WebPMaxHeight 2048
        WebPLogLevel 1

        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler
            Header set Cache-Control "public, max-age=86400"
            Header set Vary "Accept"
        </FilesMatch>
    </Directory>

    # High-resolution assets directory
    <Directory "/var/www/enterprise/images/hires">
        Options -Indexes -MultiViews
        AllowOverride None
        Require all granted

        # High-res images - maximum quality
        WebPEnabled On
        WebPStrictMode On
        WebPQuality 95.0  # Maximum quality for high-res
        WebPCacheDir /var/cache/mod_webp_enterprise/hires
        WebPMaxFileSize 209715200  # 200MB for high-res
        WebPMaxWidth 65536
        WebPMaxHeight 65536
        WebPLogLevel 2  # More verbose for high-value assets

        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler
            Header set Cache-Control "public, max-age=2592000"  # 30 days
            Header set Vary "Accept"
        </FilesMatch>
    </Directory>

    # Error and access logging
    ErrorLog /var/log/apache2/webp_enterprise_error.log
    CustomLog /var/log/apache2/webp_enterprise_access.log combined
    LogLevel info ssl:warn webp:info
</VirtualHost>

# HTTP to HTTPS redirect for security
<VirtualHost *:80>
    ServerName images.enterprise.local
    Redirect permanent / https://images.enterprise.local/
</VirtualHost>

# Development/Testing virtual host with relaxed settings
<VirtualHost *:8080>
    ServerName webp-dev.enterprise.local
    DocumentRoot /var/www/enterprise/dev

    <Directory "/var/www/enterprise/dev">
        Options -Indexes
        AllowOverride None
        Require ip 192.168.0.0/16 10.0.0.0/8 127.0.0.1

        # Development settings - non-strict mode for testing
        WebPEnabled On
        WebPStrictMode Off  # Allow fallback for testing
        WebPQuality 85.0
        WebPCacheDir /var/cache/mod_webp_dev
        WebPMaxFileSize 104857600  # 100MB
        WebPLogLevel 3  # DEBUG level for development
        WebPAllowedFormats "jpeg,png,bmp,tiff,gif"

        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif|webp)$">
            SetHandler webp-handler
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Vary "Accept"
        </FilesMatch>
    </Directory>

    ErrorLog /var/log/apache2/webp_dev_error.log
    CustomLog /var/log/apache2/webp_dev_access.log combined
    LogLevel debug
</VirtualHost>