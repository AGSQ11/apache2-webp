# test-strict.conf - Strict mode testing configuration for mod_webp
# This configuration enforces strict WebP conversion - NO IMAGE ESCAPES

# Load the module
LoadModule webp_module modules/mod_webp.so

# Test virtual host with STRICT enforcement
<VirtualHost *:80>
    ServerName strict-webp-test.local
    DocumentRoot /var/www/webp-strict-test

    # Strict WebP conversion - enterprise-grade enforcement
    <Directory "/var/www/webp-strict-test">
        Options -Indexes -MultiViews
        AllowOverride None
        Require all granted

        # STRICT MODE CONFIGURATION
        WebPEnabled On
        WebPStrictMode On  # CRITICAL: No images escape conversion
        WebPQuality 88.0
        WebPCacheDir /var/cache/mod_webp_strict
        WebPMaxFileSize 31457280  # 30MB limit
        WebPMaxWidth 8192
        WebPMaxHeight 8192
        WebPCacheTimeout 1800  # 30 minute cache
        WebPLogLevel 2  # INFO level for monitoring
        WebPAllowedFormats "jpeg,png,bmp,tiff,gif"

        # ALL image files MUST be converted - no exceptions
        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler

            # Security headers
            Header always set X-Content-Type-Options nosniff
            Header always set Cache-Control "public, max-age=86400"
            Header always set Vary "Accept"

            # In strict mode, only WebP-capable browsers get content
            # Others receive HTTP 406 Not Acceptable
            SetEnvIf Accept "image/webp" webp_browser

            # Log non-WebP browsers for monitoring
            CustomLog /var/log/apache2/webp_strict_reject.log combined env=!webp_browser
        </FilesMatch>

        # Prevent direct access to original image files in strict mode
        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            # Block browsers that don't support WebP
            Order allow,deny
            Allow from env=webp_browser
            Deny from all
            ErrorDocument 403 "WebP support required"
        </FilesMatch>

        # Allow WebP files to be served normally
        <FilesMatch "\.webp$">
            # These are already in WebP format
            Header set Content-Type "image/webp"
            Header set Cache-Control "public, max-age=31536000"
        </FilesMatch>
    </Directory>

    # Test directory for format validation
    <Directory "/var/www/webp-strict-test/samples">
        # Different quality for sample images
        WebPQuality 95.0  # Higher quality for samples
        WebPLogLevel 3   # Debug level for testing

        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler
        </FilesMatch>
    </Directory>

    # Monitoring and security
    ErrorLog /var/log/apache2/webp_strict_error.log
    CustomLog /var/log/apache2/webp_strict_access.log combined
    LogLevel info webp:debug

    # Security headers for the entire vhost
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>

# Companion virtual host for compatibility testing
<VirtualHost *:8081>
    ServerName compat-webp-test.local
    DocumentRoot /var/www/webp-compat-test

    <Directory "/var/www/webp-compat-test">
        Options -Indexes
        AllowOverride None
        Require all granted

        # COMPATIBILITY MODE - fallback allowed
        WebPEnabled On
        WebPStrictMode Off  # Allow fallback to original
        WebPQuality 85.0
        WebPCacheDir /var/cache/mod_webp_compat
        WebPLogLevel 2

        <FilesMatch "\.(jpe?g|png|bmp|tiff?|gif)$">
            SetHandler webp-handler
            Header set Vary "Accept"
        </FilesMatch>
    </Directory>

    ErrorLog /var/log/apache2/webp_compat_error.log
    CustomLog /var/log/apache2/webp_compat_access.log combined
</VirtualHost>